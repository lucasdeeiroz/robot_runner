name: Release
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  create-release:
    permissions:
      contents: write
    runs-on: ubuntu-22.04
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
    steps:
      - uses: actions/checkout@v4
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          name: Robot Runner ${{ github.ref_name }}
          body: "See the assets to download this version and install."
          draft: true
          prerelease: false
          generate_release_notes: true

  build-tauri:
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target universal-apple-darwin'
          - platform: 'ubuntu-22.04'
            args: ''
          - platform: 'windows-latest'
            args: ''
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget file libssl-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev libsoup-3.0-dev

      - name: Rust setup
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Sync node version and setup cache
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install frontend dependencies
        run: npm ci

      - name: Build the app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # tagName, releaseName, releaseBody, releaseId REMOVED to prevent auto-upload
          # We manually upload renamed artifacts in the next steps.
          args: ${{ matrix.args }}

      # Custom Artifact Renaming & Upload
      - name: Rename and Upload Artifacts (Windows)
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          $VERSION = "${{ github.ref_name }}".TrimStart('v')
          
          # Rename MSI
          $msiPath = "src-tauri/target/release/bundle/msi/Robot Runner_${VERSION}_x64_en-US.msi"
          if (Test-Path $msiPath) {
             Copy-Item $msiPath "Robot.Runner_${VERSION}_windows_x64_en-US.msi"
          }
          
          # Rename Setup EXE
          $exePath = "src-tauri/target/release/bundle/nsis/Robot Runner_${VERSION}_x64-setup.exe"
          if (Test-Path $exePath) {
             Copy-Item $exePath "Robot.Runner_${VERSION}_windows_x64-setup.exe"
          }

          # Create Portable EXE
          # Simply taking the raw binary. Note: sidecars must be in PATH on target machine.
          $binPath = "src-tauri/target/release/robot_runner.exe"
          if (Test-Path $binPath) {
             Copy-Item $binPath "Robot.Runner_${VERSION}_windows_x64-portable.exe"
          }

      - name: Rename and Upload Artifacts (Linux)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION=${VERSION#v}
          
          # AppImage
          find src-tauri/target/release/bundle/appimage -name "*.AppImage" -exec cp {} Robot.Runner_${VERSION}_linux_amd64.AppImage \;
          
          # Deb
          find src-tauri/target/release/bundle/deb -name "*.deb" -exec cp {} Robot.Runner_${VERSION}_linux_amd64.deb \;
          
          # Rpm (Tauri < v2 might stick headers, but standard name is usually package-version.arch.rpm)
          # Assuming standard build.
          # Note: rpm might not be built by default if not in tauri.conf.json targets? "all" usually includes it if tools present.
          # Ubuntu runner has rpm/alien usually? Maybe not.
          # If RPM is missing, this line just warns.
          find src-tauri/target/release/bundle/rpm -name "*.rpm" -exec cp {} Robot.Runner_${VERSION}_linux_x86_64.rpm \; || true

      - name: Rename and Upload Artifacts (macOS)
        if: matrix.platform == 'macos-latest'
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION=${VERSION#v}
          
          # DMG
          find src-tauri/target/universal-apple-darwin/release/bundle/dmg -name "*.dmg" -exec cp {} Robot.Runner_${VERSION}_macos_universal.dmg \;
          
          # App Tar Gz (Updater format usually creates this, or we zip the .app)
          # Tauri action normally creates .app.tar.gz.sig and .app.tar.gz for updater if updater active.
          # If not, we can zip the .app manually.
          if [ -d "src-tauri/target/universal-apple-darwin/release/bundle/macos/Robot Runner.app" ]; then
             tar -czf Robot.Runner_${VERSION}_macos_universal.app.tar.gz -C "src-tauri/target/universal-apple-darwin/release/bundle/macos" "Robot Runner.app"
          fi

      - name: Upload Renamed Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            Robot.Runner_*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-winget:
    needs: build-tauri
    runs-on: windows-latest
    steps:
      - name: Install WingetCreate
        run: |
          iwr https://aka.ms/wingetcreate/latest -OutFile wingetcreate.exe
      
      - name: Submit to Winget
        env:
          GITHUB_TOKEN: ${{ secrets.WINGET_TOKEN }}
        shell: pwsh
        run: |
          $VERSION = "${{ github.ref_name }}".TrimStart('v')
          $URL = "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/Robot.Runner_${VERSION}_windows_x64-setup.exe"
          
          # Only run if token exists
          if ($env:GITHUB_TOKEN) {
            # Update manifest locally first
            .\wingetcreate.exe update lucasdeeiroz.RobotRunner --version $VERSION --urls $URL --out .
            
            # Find the generated manifest directory (it creates a structure like manifests/m/...)
            $manifestDir = Get-ChildItem -Path . -Recurse -Directory | Where-Object { $_.Name -eq $VERSION } | Select-Object -First 1
            
            if ($manifestDir) {
                 Write-Host "Patching manifests in $($manifestDir.FullName)"
                 
                 # 1. Inject ReleaseDate into installer manifest
                 $date = Get-Date -Format "yyyy-MM-dd"
                 $installerManifest = Get-ChildItem -Path $manifestDir.FullName -Filter "*installer.yaml"
                 if ($installerManifest) {
                    $content = Get-Content $installerManifest.FullName -Raw
                    if (-not ($content -match "ReleaseDate:")) {
                        $content = $content + "`nReleaseDate: $date"
                        Set-Content -Path $installerManifest.FullName -Value $content
                        Write-Host "Added ReleaseDate: $date to $($installerManifest.Name)"
                    }
                 }

                 # 2. Inject ReleaseNotesUrl into locale manifest
                 $localeManifest = Get-ChildItem -Path $manifestDir.FullName -Filter "*locale.en-US.yaml"
                 if ($localeManifest) {
                    $content = Get-Content $localeManifest.FullName -Raw
                    if (-not ($content -match "ReleaseNotesUrl:")) {
                        $releaseNotesUrl = "https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
                        $content = $content + "`nReleaseNotesUrl: $releaseNotesUrl"
                        Set-Content -Path $localeManifest.FullName -Value $content
                        Write-Host "Added ReleaseNotesUrl to $($localeManifest.Name)"
                    }
                 }

                 Write-Host "Submitting manifest from $($manifestDir.FullName)"
                 .\wingetcreate.exe submit $manifestDir.FullName --token $env:GITHUB_TOKEN
            } else {
                 Write-Error "Could not find generated manifest directory."
                 exit 1
            }
          } else {
            Write-Warning "WINGET_TOKEN not set. Skipping submission."
          }
